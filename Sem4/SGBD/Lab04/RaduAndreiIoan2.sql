USE BloodBank;


--DIRTY READS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
BEGIN TRANSACTION

SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION


--DIRTY READS - rezolvare
SET TRANSACTION ISOLATION LEVEL READ COMMITTED

BEGIN TRANSACTION
SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION


----NON-REPEATABLE READS
SET TRANSACTION ISOLATION LEVEL READ COMMITTED

BEGIN TRANSACTION

SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION



--NON-REPEATABLE READS - rezolvare
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
BEGIN TRANSACTION

SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION




--PHANTOM READS
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ

BEGIN TRANSACTION

SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION



----PHANTOM READS
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE

BEGIN TRANSACTION

SELECT * FROM Donors

WAITFOR DELAY '00:00:10'

SELECT * FROM Donors
COMMIT TRANSACTION



--DEADLOCK
BEGIN TRANSACTION

UPDATE Addresses SET County='Cluj' 
WHERE AddressId = 14024

WAITFOR DELAY '00:00:10'

UPDATE Donors SET FirstName='Alexandru' 
WHERE DonorId=2
COMMIT TRANSACTION



GO
CREATE OR ALTER PROCEDURE Deadlock_Thread2 
AS

SET DEADLOCK_PRIORITY HIGH
BEGIN TRANSACTION

UPDATE Addresses SET County='Cluj' 
WHERE AddressId = 14024

WAITFOR DELAY '00:00:10'

UPDATE Donors SET FirstName='Alexandru' 
WHERE DonorId=2
COMMIT TRANSACTION


